import { Meta, Markdown } from '@storybook/addon-docs'

<Meta title="Contributing/Code Splitting" />

# Code Splitting

This document describes how to build components in a tree-shakable way.

## Dead code elimination

Dead code elimination works by statically analyzing the code in the application, and figuring out which code paths are actually being called, and then removing the stuff that is never reached.

This kind of elimination can only be done for code that is free of side-effects. If there are side-effects, such as setting a cookie or writing to `localStorage`, the code cannot be eliminated, because the analyzer doesn't know what else relies on the side-effect. The same thing is true when a web component is defined in the browser's `CustomElementRegistry`.

To get around this, Green Core exports both side-effect components that are defined automatically on import, and pure components that needs to be manually defined.

Currently, side-effect exports are exposed though the package root:

```ts
import { GdsDropdown } from '@sebgroup/green-core'
```

This imports all components in a non-tree-shakable way, meaning that even unused components will be included in the final bundle.

The pure components are exposed through a sub-path:

```ts
import { GdsDropdown } from '@sebgroup/green-core/pure'

GdsDropdown.define()
```

This will import only `GdsDropdown`, allowing for tree-shaking and reducing the final bundle size.

In a future major release, this is likely to change in order to make the pure components the default export.

## Library coding guidelines

The file structure of a components should look roughly something like this:

- my-component/
  - index.ts
  - my-component.ts
  - my-component.component.ts
  - my-component.styles.ts
  - my-component.test.ts

The important parts here are the `my-component.ts` and the `my-component.component.ts`.

The actual implementation of the component should be in `my-component.component.ts`, while `my-component.ts` should import the component, call `MyComponent.define()` and then re-export.

Example from `dropdown.ts`:

```ts
import { GdsDropdown } from './dropdown.component'

GdsDropdown.define()

export { GdsDropdown }
```

This way, the side-effect of defining the component is contained within the `my-component.ts` file, keeping the `.component.ts` file pure.

### Sub-dependencies

You should never rely on the consumer to import some vital depency on their end. If component A relies on component B for its internal structure, then component A needs to import component B.

Also in the cases where you know that a component needs to be used with a particular child-component, it makes sense for the parent component to import that child component.

### Examples

Here's some consumer code using a `gds-dropdown`:

JS:

```js
import { GdsDropdown } from '@sebgroup/green-core/pure'
GdsDropdown.define()
```

HTML:

```html
<gds-dropdown label="Select something">
  <gds-option value="first">First choice</gds-option>
  <gds-option value="second">Second choice</gds-option>
</gds-dropdown>
```

Notice that the consumer needs two components here, `gds-dropdown` and `gds-option`. Therefor, `gds-dropdown` should also import `gds-option`, because from the consumers perspective, it would be unexpected to need to import it separately.

In case a consumer also needs the types for these components, it can be helpful to forward it in the `index.ts`:

index.ts for `gds-dropdown`:

```ts
export * from './dropdown'
export * from '../../primitives/listbox/option'
```

Internally, the dropdown also use other components, such as `gds-popover` and `gds-listbox`. These are also imported by the component.

All the dependencies should be registered in the `gdsCustomElement` decorator. This makes sure that all of them are defined in the `CustomElementRegistry` when the dependant is defined.

For `gds-dropdown`, it looks like this:

```ts
@gdsCustomElement('gds-dropdown', {
  dependsOn: [
    GdsFormControlHeader,
    GdsFormControlFooter,
    GdsFieldBase,
    GdsListbox,
    GdsPopover,
    IconCheckmark,
    IconChevronBottom,
  ],
})
```
