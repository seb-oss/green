'use client'

import { useEffect, useRef, useState } from 'react'

import * as Core from '@sebgroup/green-core/react'

import './anatomy.core.css'

interface AnatomyItem {
  id: number
  label: string
  key: string
  type?: string
  description?: string
}

interface Annotation {
  id: number
  targetX: number
  targetY: number
  labelX: number
  labelY: number
}

interface AnatomyProps {
  title?: string
  items?: AnatomyItem[]
  children: React.ReactNode
}

export default function Anatomy({
  title = 'Component Anatomy',
  items: providedItems,
  children,
}: AnatomyProps) {
  const wrapperRef = useRef<HTMLDivElement>(null)

  // --- Logic State ---
  const [items, setItems] = useState<AnatomyItem[]>([])
  const [activeId, setActiveId] = useState<number | null>(null)
  const [selectedId, setSelectedId] = useState<number | null>(null)
  const [annotations, setAnnotations] = useState<Annotation[]>([])

  // --- Toggles ---
  const [isExploded, setIsExploded] = useState(false)
  const [showTraces, setShowTraces] = useState(true)

  // 1. Auto-Discovery & Calculation
  useEffect(() => {
    // Delay to allow DOM paint
    setTimeout(() => {
      if (!wrapperRef.current) return

      const els = wrapperRef.current.querySelectorAll('[data-anatomy]')
      const discovered: AnatomyItem[] = []
      const newAnnotations: Annotation[] = []

      let idCounter = 1
      const wrapperRect = wrapperRef.current.getBoundingClientRect()

      els.forEach((el) => {
        const key = el.getAttribute('data-anatomy') || ''
        el.setAttribute('data-anatomy-target', key)

        const label = el.getAttribute('data-anatomy-label') || key
        const type = el.getAttribute('data-anatomy-type') || 'element'

        const item = {
          id: idCounter,
          label,
          key,
          type,
          description: `Configuration details for ${label}.`,
        }
        discovered.push(item)

        // Annotations math (Static, no scaling needed now)
        const rect = el.getBoundingClientRect()
        // Center of element relative to wrapper
        const targetX = rect.left - wrapperRect.left + rect.width / 2
        const targetY = rect.top - wrapperRect.top + rect.height / 2

        // Tree structure for labels
        const labelX = wrapperRect.width + 80
        const verticalOffset = (idCounter - els.length / 2) * 50
        const labelY = wrapperRect.height / 2 + verticalOffset

        newAnnotations.push({ id: idCounter, targetX, targetY, labelX, labelY })
        idCounter++
      })

      setItems(providedItems || discovered)
      setAnnotations(newAnnotations)
    }, 200)
  }, [children, providedItems])

  // 2. Selection Logic
  const setHighlight = (id: number | null) => {
    if (!wrapperRef.current) return
    wrapperRef.current
      .querySelectorAll('[data-anatomy-active]')
      .forEach((el) => el.removeAttribute('data-anatomy-active'))
    if (id !== null) {
      const item = items.find((i) => i.id === id)
      if (item) {
        const target = wrapperRef.current.querySelector(
          `[data-anatomy-target="${item.key}"]`,
        )
        target?.setAttribute('data-anatomy-active', 'true')
      }
    }
  }

  const handleHover = (id: number | null) => {
    if (selectedId) return
    setActiveId(id)
    setHighlight(id)
  }

  const handleClick = (id: number) => {
    const newId = selectedId === id ? null : id
    setSelectedId(newId)
    setActiveId(newId)
    setHighlight(newId)
  }

  const currentId = selectedId || activeId
  const currentItem = items.find((i) => i.id === currentId)

  return (
    <Core.GdsFlex
      flex-direction="column"
      width="100%"
      height="700px"
      border="4xs/primary"
    >
      {/* --- Toolbar --- */}
      <Core.GdsFlex
        padding="s"
        align-items="center"
        justify-content="space-between"
        border="0 0 4xs 0"
        border-color="primary"
        background="primary"
      >
        <Core.GdsText font="heading-xs">{title}</Core.GdsText>

        <Core.GdsFlex gap="l" align-items="center">
          <label
            style={{
              display: 'flex',
              alignItems: 'center',
              gap: '8px',
              cursor: 'pointer',
            }}
          >
            <input
              type="checkbox"
              checked={showTraces}
              onChange={(e) => setShowTraces(e.target.checked)}
              style={{ accentColor: 'black' }}
            />
            <Core.GdsText font="detail-s">Show Traces</Core.GdsText>
          </label>

          <label
            style={{
              display: 'flex',
              alignItems: 'center',
              gap: '8px',
              cursor: 'pointer',
            }}
          >
            <input
              type="checkbox"
              checked={isExploded}
              onChange={(e) => setIsExploded(e.target.checked)}
              style={{ accentColor: 'black' }}
            />
            <Core.GdsText font="detail-s">Exploded View</Core.GdsText>
          </label>
        </Core.GdsFlex>
      </Core.GdsFlex>

      {/* --- Workspace --- */}
      <Core.GdsFlex flex="1" overflow="hidden" position="relative">
        {/* --- Viewport --- */}
        <div className="anatomy-viewport" style={{ flex: 1 }}>
          <div className="anatomy-canvas">
            {/* 
                    data-exploded triggers the rotation.
                    Children hover triggers the translateZ.
                */}
            <div
              className="component-context"
              ref={wrapperRef}
              data-exploded={isExploded}
            >
              {children}

              {/* Traces Overlay (Inside context, so it rotates with component) */}
              {showTraces && (
                <div className="anatomy-traces-layer">
                  <svg
                    width="100%"
                    height="100%"
                    style={{ overflow: 'visible' }}
                  >
                    {annotations.map((ann) => {
                      const isActive = currentId === ann.id
                      const opacity =
                        currentId === null ? 0.3 : isActive ? 1 : 0.05
                      return (
                        <g
                          key={ann.id}
                          style={{ opacity, transition: 'opacity 0.3s' }}
                        >
                          <path
                            className="trace-path"
                            d={`
                                                    M ${ann.targetX} ${ann.targetY} 
                                                    L ${ann.targetX + 30} ${ann.targetY}
                                                    L ${ann.targetX + 30} ${ann.labelY}
                                                    L ${ann.labelX} ${ann.labelY}
                                                `}
                          />
                          <circle
                            cx={ann.targetX}
                            cy={ann.targetY}
                            r={3}
                            fill="#000"
                          />
                        </g>
                      )
                    })}
                  </svg>

                  {/* Badges */}
                  {annotations.map((ann) => {
                    const isActive = currentId === ann.id
                    const opacity = currentId === null ? 1 : isActive ? 1 : 0.2
                    return (
                      <div
                        key={ann.id}
                        className="anatomy-annotation"
                        style={{
                          left: ann.labelX,
                          top: ann.labelY,
                          opacity,
                          background: isActive ? '#000' : '#666',
                          transform: isActive
                            ? 'translate(-50%, -50%) scale(1.3)'
                            : 'translate(-50%, -50%)',
                        }}
                        onClick={(e) => {
                          e.stopPropagation()
                          handleClick(ann.id)
                        }}
                      >
                        {ann.id}
                      </div>
                    )
                  })}
                </div>
              )}
            </div>
          </div>
        </div>

        {/* --- Sidebar Legend --- */}
        <Core.GdsCard
          width="300px"
          height="100%"
          padding="m"
          border="0 0 0 4xs"
          border-color="primary"
          style={{ zIndex: 20, overflowY: 'auto', background: '#fff' }}
        >
          <Core.GdsText
            font="detail-s"
            color="secondary"
            margin="0 0 s 0"
            transform="uppercase"
          >
            Legend
          </Core.GdsText>

          <Core.GdsFlex flex-direction="column" gap="xs">
            {items.map((item) => (
              <Core.GdsFlex
                key={item.id}
                className="list-item-row"
                align-items="center"
                padding="xs"
                gap="s"
                data-active={currentId === item.id}
                onMouseEnter={() => handleHover(item.id)}
                onMouseLeave={() => handleHover(selectedId)}
                onClick={() => handleClick(item.id)}
              >
                <Core.GdsBadge
                  variant={currentId === item.id ? 'positive' : 'notice'}
                  size="small"
                >
                  {item.id}
                </Core.GdsBadge>
                <Core.GdsFlex flex-direction="column">
                  <Core.GdsText font="detail-s" weight="bold">
                    {item.label}
                  </Core.GdsText>
                  <Core.GdsText font="detail-xs" color="secondary">
                    {item.type || 'Element'}
                  </Core.GdsText>
                </Core.GdsFlex>
              </Core.GdsFlex>
            ))}
          </Core.GdsFlex>

          {/* --- Info Panel --- */}
          <div
            style={{
              marginTop: '24px',
              opacity: selectedId ? 1 : 0,
              transform: selectedId ? 'translateY(0)' : 'translateY(10px)',
              transition: 'all 0.3s ease',
            }}
          >
            {selectedId && currentItem && (
              <Core.GdsCard
                padding="m"
                background="secondary"
                border="4xs/primary"
              >
                <Core.GdsText font="detail-s" weight="bold" margin="0 0 xs 0">
                  {currentItem.label}
                </Core.GdsText>
                <Core.GdsText font="body-s" margin="0 0 m 0">
                  {currentItem.description}
                </Core.GdsText>
                <Core.GdsButton size="small" rank="tertiary" width="100%">
                  View Docs
                </Core.GdsButton>
              </Core.GdsCard>
            )}
          </div>
        </Core.GdsCard>
      </Core.GdsFlex>
    </Core.GdsFlex>
  )
}
